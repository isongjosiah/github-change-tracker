package tests

import (
	"bytes"
	"encoding/json"
	"heimdall/internal/dal/model"
	"net/http"
	"net/http/httptest"
	"testing"
	"time"

	"gotest.tools/assert"
)

func TestCommitPooling(t *testing.T) {
	databaseRepoRes := []model.Repository{
		{
			ID:          1,
			Owner:       "octocat",
			Name:        "hello-world",
			URL:         "https://github.com/octocat/hello-world",
			LastFetched: time.Now().Add(-24 * time.Hour),
			CreatedAt:   time.Now().Add(-72 * time.Hour),
			UpdatedAt:   time.Now(),
		},
		{
			ID:          2,
			Owner:       "openai",
			Name:        "gpt-codebase",
			URL:         "https://github.com/openai/gpt-codebase",
			LastFetched: time.Now().Add(-6 * time.Hour),
			CreatedAt:   time.Now().Add(-48 * time.Hour),
			UpdatedAt:   time.Now(),
		},
	}
	//listCommitResponse := []github.Commit{
	//	{
	//		URL:         "https://api.github.com/repos/user/repo/commits/1",
	//		SHA:         "sha1",
	//		CommentsURL: "https://api.github.com/repos/user/repo/commits/1/comments",
	//		Commit: struct {
	//			URL    string `json:"url"`
	//			Author struct {
	//				Name  string    `json:"name"`
	//				Email string    `json:"email"`
	//				Date  time.Time `json:"date"`
	//			} `json:"author"`
	//			Committer struct {
	//				Name  string    `json:"name"`
	//				Email string    `json:"email"`
	//				Date  time.Time `json:"date"`
	//			} `json:"committer"`
	//			Message      string `json:"message"`
	//			CommentCount int    `json:"comment_count"`
	//		}{
	//			URL: "https://api.github.com/repos/user/repo/git/commits/1",
	//			Author: struct {
	//				Name  string    `json:"name"`
	//				Email string    `json:"email"`
	//				Date  time.Time `json:"date"`
	//			}{
	//				Name:  "Author1",
	//				Email: "author1@example.com",
	//				Date:  time.Now().AddDate(0, 0, -1),
	//			},
	//			Committer: struct {
	//				Name  string    `json:"name"`
	//				Email string    `json:"email"`
	//				Date  time.Time `json:"date"`
	//			}{
	//				Name:  "Committer1",
	//				Email: "committer1@example.com",
	//				Date:  time.Now().AddDate(0, 0, -1),
	//			},
	//			Message:      "Commit message 1",
	//			CommentCount: 10,
	//		},
	//	},
	//	{
	//		URL:         "https://api.github.com/repos/user/repo/commits/2",
	//		SHA:         "sha2",
	//		CommentsURL: "https://api.github.com/repos/user/repo/commits/2/comments",
	//		Commit: struct {
	//			URL    string `json:"url"`
	//			Author struct {
	//				Name  string    `json:"name"`
	//				Email string    `json:"email"`
	//				Date  time.Time `json:"date"`
	//			} `json:"author"`
	//			Committer struct {
	//				Name  string    `json:"name"`
	//				Email string    `json:"email"`
	//				Date  time.Time `json:"date"`
	//			} `json:"committer"`
	//			Message      string `json:"message"`
	//			CommentCount int    `json:"comment_count"`
	//		}{
	//			URL: "https://api.github.com/repos/user/repo/git/commits/2",
	//			Author: struct {
	//				Name  string    `json:"name"`
	//				Email string    `json:"email"`
	//				Date  time.Time `json:"date"`
	//			}{
	//				Name:  "Author2",
	//				Email: "author2@example.com",
	//				Date:  time.Now().AddDate(0, 0, -2),
	//			},
	//			Committer: struct {
	//				Name  string    `json:"name"`
	//				Email string    `json:"email"`
	//				Date  time.Time `json:"date"`
	//			}{
	//				Name:  "Committer2",
	//				Email: "committer2@example.com",
	//				Date:  time.Now().AddDate(0, 0, -2),
	//			},
	//			Message:      "Commit message 2",
	//			CommentCount: 8,
	//		},
	//	},
	//	{
	//		URL:         "https://api.github.com/repos/user/repo/commits/3",
	//		SHA:         "sha3",
	//		CommentsURL: "https://api.github.com/repos/user/repo/commits/3/comments",
	//		Commit: struct {
	//			URL    string `json:"url"`
	//			Author struct {
	//				Name  string    `json:"name"`
	//				Email string    `json:"email"`
	//				Date  time.Time `json:"date"`
	//			} `json:"author"`
	//			Committer struct {
	//				Name  string    `json:"name"`
	//				Email string    `json:"email"`
	//				Date  time.Time `json:"date"`
	//			} `json:"committer"`
	//			Message      string `json:"message"`
	//			CommentCount int    `json:"comment_count"`
	//		}{
	//			URL: "https://api.github.com/repos/user/repo/git/commits/3",
	//			Author: struct {
	//				Name  string    `json:"name"`
	//				Email string    `json:"email"`
	//				Date  time.Time `json:"date"`
	//			}{
	//				Name:  "Author3",
	//				Email: "author3@example.com",
	//				Date:  time.Now().AddDate(0, 0, -3),
	//			},
	//			Committer: struct {
	//				Name  string    `json:"name"`
	//				Email string    `json:"email"`
	//				Date  time.Time `json:"date"`
	//			}{
	//				Name:  "Committer3",
	//				Email: "committer3@example.com",
	//				Date:  time.Now().AddDate(0, 0, -3),
	//			},
	//			Message:      "Commit message 3",
	//			CommentCount: 5,
	//		},
	//	},
	//	{
	//		URL:         "https://api.github.com/repos/user/repo/commits/4",
	//		SHA:         "sha4",
	//		CommentsURL: "https://api.github.com/repos/user/repo/commits/4/comments",
	//		Commit: struct {
	//			URL    string `json:"url"`
	//			Author struct {
	//				Name  string    `json:"name"`
	//				Email string    `json:"email"`
	//				Date  time.Time `json:"date"`
	//			} `json:"author"`
	//			Committer struct {
	//				Name  string    `json:"name"`
	//				Email string    `json:"email"`
	//				Date  time.Time `json:"date"`
	//			} `json:"committer"`
	//			Message      string `json:"message"`
	//			CommentCount int    `json:"comment_count"`
	//		}{
	//			URL: "https://api.github.com/repos/user/repo/git/commits/4",
	//			Author: struct {
	//				Name  string    `json:"name"`
	//				Email string    `json:"email"`
	//				Date  time.Time `json:"date"`
	//			}{
	//				Name:  "Author4",
	//				Email: "author4@example.com",
	//				Date:  time.Now().AddDate(0, 0, -4),
	//			},
	//			Committer: struct {
	//				Name  string    `json:"name"`
	//				Email string    `json:"email"`
	//				Date  time.Time `json:"date"`
	//			}{
	//				Name:  "Committer4",
	//				Email: "committer4@example.com",
	//				Date:  time.Now().AddDate(0, 0, -4),
	//			},
	//			Message:      "Commit message 4",
	//			CommentCount: 12,
	//		},
	//	},
	//}

	repositoryDal.ListReturnsOnCall(0, databaseRepoRes, nil)
	repositoryDal.ListReturnsOnCall(1, nil, nil)

	restApi.Logic.Repository.ScheduleRepositoryPool()
	assert.Equal(t, 2, repositoryDal.ListCallCount())
	assert.Equal(t, 2, producer.PublishMessageCallCount())
}

func TestRepoCreation(t *testing.T) {
	tests := []struct {
		name       string
		newRepo    model.NewRepository
		statusCode int
	}{}

	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			data, _ := json.Marshal(tt.newRepo)

			url := "/auth/signup"
			req := httptest.NewRequest(http.MethodPost, url, bytes.NewBuffer(data))
		})
	}
}
